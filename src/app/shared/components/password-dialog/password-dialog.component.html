<div class="password-dialog">
  @if (!showSuccessState) {
    <!-- Password Confirmation State -->
    <h2 mat-dialog-title class="dialog-title">
      <mat-icon class="dialog-icon">lock</mat-icon>
      Confirm Password
    </h2>

    <mat-dialog-content class="dialog-content">
      <p class="dialog-message">
        To update your email address, please enter your current password to verify your identity.
      </p>

      <form [formGroup]="passwordForm" (ngSubmit)="onSubmit()">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>Current Password</mat-label>
          <input
            matInput
            [type]="hidePassword ? 'password' : 'text'"
            formControlName="password"
            placeholder="Enter your current password"
            autocomplete="current-password"
          >
          <button
            type="button"
            mat-icon-button
            matSuffix
            (click)="togglePasswordVisibility()"
            [attr.aria-label]="'Hide password'"
            [attr.aria-pressed]="hidePassword"
          >
            <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
          </button>
          
          @if (password?.invalid && password?.touched) {
            <mat-error>
              {{ getErrorMessage() }}
            </mat-error>
          }
          
        </mat-form-field>
      </form>
    </mat-dialog-content>

    <mat-dialog-actions class="dialog-actions">
      <button
        mat-button
        type="button"
        (click)="onCancel()"
        [disabled]="isLoading"
      >
        Cancel
      </button>
      <button
        mat-raised-button
        color="primary"
        type="submit"
        (click)="onSubmit()"
        [disabled]="passwordForm.invalid || isLoading"
      >
        <mat-icon *ngIf="isLoading">hourglass_empty</mat-icon>
        {{ isLoading ? 'Verifying...' : 'Confirm' }}
      </button>
    </mat-dialog-actions>
  } @else {
    <!-- Verification Email Sent State -->
    <h2 mat-dialog-title class="dialog-title">
      <mat-icon class="dialog-icon success">email</mat-icon>
      Verification Email Sent
    </h2>

    <mat-dialog-content class="dialog-content">
      <p class="dialog-message">
        We've sent a verification email to your new email address. Please check your inbox and click the verification link to complete your email change.
      </p>
      
      <div class="verification-instructions">
        <h4>Next steps:</h4>
        <ol>
          <li>Check your new email inbox</li>
          <li>Click the verification link in the email</li>
          <li>Return to this page - your email will update automatically</li>
        </ol>
      </div>
    </mat-dialog-content>

    <mat-dialog-actions class="dialog-actions">
      <button
        mat-raised-button
        color="primary"
        (click)="closeDialog()"
      >
        <mat-icon>check</mat-icon>
        Got it
      </button>
    </mat-dialog-actions>
  }
</div>