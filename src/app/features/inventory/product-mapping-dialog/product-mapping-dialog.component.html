<div class="product-mapping-dialog">
  <div mat-dialog-title class="dialog-header">
    <div class="header-content">
      <mat-icon class="header-icon">link</mat-icon>
      <div class="header-text">
        <h2>Product-Square Mapping</h2>
        <span class="subtitle">Connect your LobbyTrace products with Square items for automatic inventory updates</span>
      </div>
    </div>
    <button mat-icon-button (click)="onCancel()" [disabled]="isLoading()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-dialog-content class="dialog-content">
    <mat-progress-spinner 
      *ngIf="isLoading()" 
      diameter="40" 
      mode="indeterminate"
      class="loading-spinner">
    </mat-progress-spinner>

    <mat-tab-group [selectedIndex]="selectedTab()" (selectedIndexChange)="selectedTab.set($event)">
      
      <!-- Existing Mappings Tab -->
      <mat-tab label="Current Mappings">
        <div class="tab-content">
          <div class="tab-header">
            <mat-icon>assignment</mat-icon>
            <div>
              <h3>Active Product Mappings</h3>
              <p>Manage existing connections between your products and Square items</p>
            </div>
          </div>

          <div *ngIf="existingMappings().length === 0" class="empty-state">
            <mat-icon>link_off</mat-icon>
            <h3>No Mappings Configured</h3>
            <p>Create your first product mapping using the tabs above</p>
          </div>

          <mat-table *ngIf="existingMappings().length > 0" [dataSource]="existingMappings()" class="mappings-table">
            <ng-container matColumnDef="productName">
              <mat-header-cell *matHeaderCellDef>LobbyTrace Product</mat-header-cell>
              <mat-cell *matCellDef="let mapping">
                <div class="product-cell">
                  <span class="product-name">{{ mapping.productName }}</span>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="squareItemName">
              <mat-header-cell *matHeaderCellDef>Square Item</mat-header-cell>
              <mat-cell *matCellDef="let mapping">
                <div class="square-item-cell">
                  <mat-icon class="square-icon">storefront</mat-icon>
                  <span>{{ mapping.squareItemName }}</span>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="syncEnabled">
              <mat-header-cell *matHeaderCellDef>Sync Status</mat-header-cell>
              <mat-cell *matCellDef="let mapping">
                <mat-slide-toggle 
                  [checked]="mapping.syncEnabled"
                  (change)="toggleMappingSync(mapping, $event.checked)">
                  {{ mapping.syncEnabled ? 'Enabled' : 'Disabled' }}
                </mat-slide-toggle>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="lastSyncedAt">
              <mat-header-cell *matHeaderCellDef>Last Synced</mat-header-cell>
              <mat-cell *matCellDef="let mapping">{{ formatDate(mapping.lastSyncedAt) }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="actions">
              <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
              <mat-cell *matCellDef="let mapping">
                <button mat-icon-button 
                        color="warn"
                        (click)="deleteMapping(mapping)"
                        matTooltip="Delete Mapping">
                  <mat-icon>delete</mat-icon>
                </button>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="mappingColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: mappingColumns;"></mat-row>
          </mat-table>
        </div>
      </mat-tab>

      <!-- Smart Suggestions Tab -->
      <mat-tab label="Smart Suggestions">
        <div class="tab-content">
          <div class="tab-header">
            <mat-icon>auto_awesome</mat-icon>
            <div>
              <h3>AI-Powered Mapping Suggestions</h3>
              <p>Review automatically detected matches between your products and Square items</p>
            </div>
          </div>

          <div *ngIf="suggestions().length === 0" class="empty-state">
            <mat-icon>search_off</mat-icon>
            <h3>No Suggestions Available</h3>
            <p>All products may already be mapped, or no clear matches were found</p>
          </div>

          <mat-table *ngIf="suggestions().length > 0" [dataSource]="suggestions()" class="suggestions-table">
            <ng-container matColumnDef="productName">
              <mat-header-cell *matHeaderCellDef>LobbyTrace Product</mat-header-cell>
              <mat-cell *matCellDef="let suggestion">
                <div class="product-cell">
                  <span class="product-name">{{ suggestion.lobbyTraceProduct.name }}</span>
                  <span *ngIf="suggestion.lobbyTraceProduct.variation" class="product-variation">
                    {{ suggestion.lobbyTraceProduct.variation }}
                    {{ suggestion.lobbyTraceProduct.token ? ('(' + suggestion.lobbyTraceProduct.token + ')') : '' }}
                  </span>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="squareItemName">
              <mat-header-cell *matHeaderCellDef>Suggested Square Item</mat-header-cell>
              <mat-cell *matCellDef="let suggestion">
                <div class="square-item-cell">
                  <mat-icon class="square-icon">storefront</mat-icon>
                  <span>{{ getSquareItemDisplayName(suggestion.squareItem) }}</span>
                </div>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="confidence">
              <mat-header-cell *matHeaderCellDef>Confidence</mat-header-cell>
              <mat-cell *matCellDef="let suggestion">
                <mat-chip [color]="getConfidenceColor(suggestion.confidence)">
                  {{ getConfidenceText(suggestion.confidence) }}
                </mat-chip>
              </mat-cell>
            </ng-container>

            <ng-container matColumnDef="reason">
              <mat-header-cell *matHeaderCellDef>Match Reason</mat-header-cell>
              <mat-cell *matCellDef="let suggestion">{{ suggestion.reason }}</mat-cell>
            </ng-container>

            <ng-container matColumnDef="actions">
              <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
              <mat-cell *matCellDef="let suggestion">
                <button mat-raised-button 
                        color="primary"
                        (click)="acceptSuggestion(suggestion)">
                  <mat-icon>check</mat-icon>
                  Accept
                </button>
              </mat-cell>
            </ng-container>

            <mat-header-row *matHeaderRowDef="suggestionColumns"></mat-header-row>
            <mat-row *matRowDef="let row; columns: suggestionColumns;"></mat-row>
          </mat-table>
        </div>
      </mat-tab>

      <!-- Manual Mapping Tab -->
      <mat-tab label="Manual Mapping">
        <div class="tab-content">
          <div class="tab-header">
            <mat-icon>link</mat-icon>
            <div>
              <h3>Create Manual Mapping</h3>
              <p>Manually connect a LobbyTrace product with a Square item</p>
            </div>
          </div>

          <mat-card class="mapping-form-card">
            <mat-card-content>
              <form [formGroup]="manualMappingForm" (ngSubmit)="createManualMapping()" class="mapping-form">
                <!-- Product Selection -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>LobbyTrace Product</mat-label>
                  <mat-select formControlName="productId" placeholder="Select a product">
                    <mat-option *ngFor="let product of getUnmappedProducts()" [value]="product.id">
                      <div class="product-option">
                        <span class="product-name">{{product.token}} - {{ product.name }}</span>
                        <span *ngIf="product.variation" class="product-variation">{{ product.variation }}</span>
                        <span class="product-category">{{ product.category }}</span>
                      </div>
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="manualMappingForm.get('productId')?.hasError('required')">
                    Please select a product
                  </mat-error>
                </mat-form-field>

                <!-- Square Item Pagination Controls -->
                <div class="pagination-controls mb-4">
                  <div class="flex justify-between items-center">
                    <div class="pagination-info">
                      <span class="text-sm text-gray-600">{{ getCurrentPageRange() }}</span>
                    </div>
                    
                    <div class="pagination-actions flex items-center gap-2">
                      <!-- Page Size Selector -->
                      <mat-form-field appearance="outline" class="page-size-field">
                        <mat-label>Page Size</mat-label>
                        <mat-select [value]="pageSize()" (selectionChange)="changePageSize($event.value)" [disabled]="showAllItems()">
                          <mat-option *ngFor="let size of availablePageSizes" [value]="size">
                            {{ size }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                      
                      <!-- Show All Toggle -->
                      <mat-button-toggle-group [value]="showAllItems()" (valueChange)="toggleShowAll()">
                        <mat-button-toggle [value]="false">Paginated</mat-button-toggle>
                        <mat-button-toggle [value]="true">Show All</mat-button-toggle>
                      </mat-button-toggle-group>
                    </div>
                  </div>
                  
                  <!-- Pagination Navigation (only show when not showing all) -->
                  @if (!showAllItems()) {
                    <div class="pagination-nav flex items-center justify-center mt-2 gap-2">
                      <button mat-icon-button [disabled]="currentPage() === 0" (click)="previousPage()">
                        <mat-icon>chevron_left</mat-icon>
                      </button>
                      
                      <span class="text-sm">
                        Page {{ currentPage() + 1 }} of {{ getTotalPages() }}
                      </span>
                      
                      <button mat-icon-button [disabled]="currentPage() >= getTotalPages() - 1" (click)="nextPage()">
                        <mat-icon>chevron_right</mat-icon>
                      </button>
                    </div>
                  }
                </div>

                <!-- Square Item Selection -->
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Square Item</mat-label>
                  <mat-select formControlName="squareItemId" placeholder="Select a Square item">
                    <mat-option *ngFor="let item of getUnmappedSquareItems()" [value]="item.id">
                      <div class="square-item-option">
                        <span>{{ getSquareItemDisplayName(item) }}</span>
                      </div>
                    </mat-option>
                  </mat-select>
                  <mat-error *ngIf="manualMappingForm.get('squareItemId')?.hasError('required')">
                    Please select a Square item
                  </mat-error>
                </mat-form-field>

                <!-- Create Button -->
                <div class="form-actions">
                  <button mat-raised-button 
                          color="primary" 
                          type="submit"
                          [disabled]="manualMappingForm.invalid || isLoading()">
                    <mat-icon>add_link</mat-icon>
                    Create Mapping
                  </button>
                </div>
              </form>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-dialog-content>

  <mat-dialog-actions class="dialog-actions">
    <button mat-button (click)="onCancel()">Cancel</button>
    <button mat-raised-button color="primary" (click)="onClose()">
      Done
    </button>
  </mat-dialog-actions>
</div>